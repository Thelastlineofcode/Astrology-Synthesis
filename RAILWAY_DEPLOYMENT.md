# Railway Backend Deployment Guide

## Prerequisites

- Railway account (sign up at railway.app)
- GitHub repository connected
- PostgreSQL database ready (will be created in Railway)

## Step 1: Install Railway CLI (Optional)

```bash
npm i -g @railway/cli
railway login
```

## Step 2: Create New Railway Project

### Via Railway Dashboard (Recommended)

1. Go to https://railway.app/new
2. Click "Deploy from GitHub repo"
3. Select `Thelastlineofcode/Astrology-Synthesis`
4. Choose "Empty Service" first

### Via CLI

```bash
cd /workspaces/Astrology-Synthesis
railway init
railway link
```

## Step 3: Add PostgreSQL Database

1. In Railway Dashboard → New → Database → PostgreSQL
2. Railway will auto-generate `DATABASE_URL` environment variable
3. Note: The database will be automatically linked to your service

### Database Connection String Format

```
postgresql://user:password@host:port/database
```

## Step 4: Configure Environment Variables

In Railway Dashboard → Your Service → Variables, add:

### Required Variables

```bash
# Database (Auto-generated by Railway)
DATABASE_URL=postgresql://...

# JWT Authentication
JWT_SECRET=your-super-secret-min-32-chars-long-key
JWT_ALGORITHM=HS256
JWT_EXPIRATION=3600

# API Configuration
ENVIRONMENT=production
DEBUG=false
CORS_ORIGINS=["https://astrology-synthesis.vercel.app","https://mula.vercel.app"]

# Perplexity AI (if using)
PERPLEXITY_API_KEY=your-perplexity-api-key-here
```

### Optional Variables

```bash
# Sentry Error Tracking
SENTRY_DSN=https://xxxxx@sentry.io/xxxxx

# Redis (if using caching)
REDIS_URL=redis://...
```

### Generate JWT Secret

```bash
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

## Step 5: Configure Deployment Settings

In Railway Dashboard → Settings:

### Build & Deploy

- **Builder**: Dockerfile
- **Dockerfile Path**: `backend/Dockerfile`
- **Start Command**: `uvicorn main:app --host 0.0.0.0 --port $PORT`
- **Root Directory**: (leave empty or set to root)

### Health Check

- **Path**: `/health`
- **Timeout**: 30 seconds
- **Interval**: 60 seconds

### Auto-Deploy

- ✅ Enable "Automatic deployments from GitHub"
- Production Branch: `master` or `main`

## Step 6: Update Dockerfile for Railway

The existing Dockerfile should work, but ensure it uses Railway's `$PORT`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install dependencies
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY backend/ .

# Expose port (Railway assigns dynamically)
EXPOSE $PORT

# Start command
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "$PORT"]
```

**Note**: Current Dockerfile is at `/workspaces/Astrology-Synthesis/backend/Dockerfile`

## Step 7: Initialize Database

Once deployed, run migrations:

### Via Railway CLI

```bash
railway run alembic upgrade head
```

### Manually (if needed)

```bash
# Connect to Railway PostgreSQL
railway connect postgres

# Run SQL scripts
\i database/init.sql
```

## Step 8: Deploy

### Via Dashboard

1. Railway will automatically deploy on first push
2. Monitor deployment in Dashboard → Deployments

### Via CLI

```bash
cd /workspaces/Astrology-Synthesis
railway up
```

### Via Git Push

```bash
git add .
git commit -m "Configure Railway deployment"
git push origin master
```

Railway will automatically detect changes and deploy.

## Step 9: Get Deployment URL

Railway provides a URL automatically:

- Format: `https://your-service-name.up.railway.app`
- Custom domain can be added in Settings → Domains

### Update Frontend Environment

Update Vercel environment variable:

```
NEXT_PUBLIC_API_URL=https://your-backend.up.railway.app
```

## Step 10: Verify Deployment

### Test Health Endpoint

```bash
curl https://your-backend.up.railway.app/health
```

Expected response:

```json
{
  "status": "healthy",
  "version": "1.0.0"
}
```

### Test API Documentation

Visit: `https://your-backend.up.railway.app/docs`

### Test CORS

```bash
curl -H "Origin: https://astrology-synthesis.vercel.app" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS \
     https://your-backend.up.railway.app/api/v1/auth/login
```

## Step 11: Monitor Application

### View Logs

```bash
# Via CLI
railway logs

# Via Dashboard
Dashboard → Deployments → [Latest] → Logs
```

### Monitor Metrics

Railway Dashboard provides:

- CPU usage
- Memory usage
- Network traffic
- Response times
- Error rates

## Troubleshooting

### Build Fails

```bash
# Check logs
railway logs --build

# Common issues:
# - Missing dependencies in requirements.txt
# - Dockerfile path incorrect
# - Python version mismatch
```

### Database Connection Issues

```bash
# Verify DATABASE_URL is set
railway variables

# Test connection
railway run python -c "from sqlalchemy import create_engine; engine = create_engine('$DATABASE_URL'); print('Connected!')"
```

### CORS Errors

1. Check `CORS_ORIGINS` includes your frontend domain
2. Verify frontend is using correct API URL
3. Test with curl to isolate issue

### App Won't Start

1. Check start command: `uvicorn main:app --host 0.0.0.0 --port $PORT`
2. Verify `$PORT` environment variable is used
3. Check logs for Python errors

## Performance Optimization

### Enable Redis Caching (Optional)

```bash
# In Railway Dashboard
New → Database → Redis

# Add to environment variables
REDIS_URL=<auto-generated>
```

### Database Optimization

```bash
# Create indexes for frequently queried fields
railway connect postgres

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_charts_user_id ON charts(user_id);
```

## Scaling

### Vertical Scaling

Railway Dashboard → Settings → Resources:

- Increase CPU/Memory allocation
- Plans start at $5/month

### Horizontal Scaling

- Railway supports multiple replicas
- Enable in Settings → Replicas

## Cost Estimation

### Free Tier

- $5 free credits/month
- Suitable for development/testing

### Production

- ~$20-50/month for backend + database
- Scales with usage

## Post-Deployment Checklist

- [ ] Health endpoint returns 200
- [ ] API docs accessible at `/docs`
- [ ] Database connection working
- [ ] Frontend can reach backend (no CORS errors)
- [ ] Environment variables set correctly
- [ ] Auto-deploy enabled
- [ ] Monitoring/logging active
- [ ] Custom domain configured (optional)

## Alternative: Render

If using Render instead of Railway:

```bash
# Create new Web Service
# Connect GitHub repo
# Runtime: Python 3.11
# Build command: pip install -r backend/requirements.txt
# Start command: uvicorn main:app --host 0.0.0.0 --port $PORT
# Add PostgreSQL database service
# Set same environment variables as above
```

## Support

- Railway Docs: https://docs.railway.app
- FastAPI Docs: https://fastapi.tiangolo.com
- PostgreSQL Docs: https://www.postgresql.org/docs/
- GitHub Issues: https://github.com/Thelastlineofcode/Astrology-Synthesis/issues
